\chapter{The \texorpdfstring{$\chi^{2}$}{Chi-squared} test}
\label{chap:chisquared}

%\section{\texorpdfstring{$\chi^{2}$}{Chi-squared} test for distributions}
%
%Wanneer alle variabelen in het onderzoek nominaal zijn, is chi kwadraat de eenvoudigste (en populairste) techniek die men ter beschikking heeft voor het toetsten van hypothesen. De teststatistiek heet chi kwadraat, en is verdeeld volgens de chi kwadraat verdeling. De test kan gebruikt worden om na te gaan in welke mate de steekproef overeenstemt met een nulhypothese over de verdeling van de variabele. Men noemt dit een \textit{goodness of fit} \index{Test goodness of fit} test.
%
%In het voorbeeld op de slides willen we nagaan, of de verdeling van onze steekproef bij $n = 400$ superhelden overeenstemt met de verdeling die je verwacht in de volledige populatie (de verzameling van alle mogelijke superhelden). 
%
%Daartoe vergelijken we de aantallen in de steekproef met de aantallen die je zou verwachten als de steeproef exact representatief zou zijn naar de types van superhelden. Als deze verschillen relatief groot zijn dan komt de verdeling in de steekproef niet overeen met de verdeling in de populaties en zullen we moeten concluderen dat de steekproef niet representatief is. Om te oordelen of deze verschillen relatief groot zijn voeren we een $\chi^{2}$toets uit. 
%
%
%\subsection{Voorbeeld superhelden}
%We willen kijken of de steekproef voor onze superhelden representatief is. Als de steekproef exact representatief zou zijn zouden we verwachten dat in de steekproef 35\% van de superhelden een mutant zou zijn. Het verwachte aantal of de verwachte frequentie voor deze categorie is dus gelijk aan $0,35 \times 400 = 140$. De verwachte frequenties worden genoteerd met de letter $e$ (expected). Er geldt dus:
%
%\[ e = n \times \pi \]
%
%met $\pi$ de frequentie over de hele populatie. Als de verschillen $o - e$ ($o$ staat voor observed) reletief klein zijn kunnen ze toegerekend worden aan toevallige steekproeffouten. We gaan nu een toetsingsgrootheid bepalen waarmee getoetst kan worden of de steekproefverdeling overeenkomt met de gegeven verdeling in de populatie.
%
%Beschouw $\chi^{2}$:
%
%\[ \chi^{2} = \sum_{i=1}^{n} \frac{(o_{i} - e_{i})^{2}}{e_{i}} \]
%
%We merken op:
%\begin{itemize}
%	\item indien de verschillen klein zijn $\Rightarrow$ verdeling komt voldoende overeen
%	\item indien de verschillen groot $\Rightarrow$ verdeling niet representatief
%\end{itemize}
%
%We bepalen nu een kritieke grenswaarde $g$ die een $\chi^{2}$ verdeling heeft. Hierbij speel het aantal vrijheidsgraden een rol ($df$). Er geldt:
%
%\[ df = k -1 \]
%
%met $k$ het aantal categorie\"en. In ons voorbeeld hebben we $df = 5-1 = 4$. Om de kritieke grenswaarde te bepalen, kan je gebruik maken van een tabel voor de $\chi^2$-verdeling. Voor een gegeven significantieniveau $\alpha$ en vrijheidsgraad $df$ kan je in zo'n tabel de grenswaarde aflezen.
%
%In ons voorbeeld is $\chi^{2} = 3,47$ met grenswaarde $g = 9,49$. Omdat de gevonden toetsingsgrootheid $\chi^2 = 3,47 < g = 9,49$, mogen we besluiten dat de steekproef representatief is.
%
%
%\subsection{Toetsingsprocedure}
%We gaan ons 5-stappenplan invullen.
%
%\begin{enumerate}
%	\item \textbf{Bepalen hypotheses}
%		Als nulhypothese formuleren we dat de verdeling over de opleidingen in de steekproef gelijk is aan de verdeling in de populatie. Als alternatieve hypothese formuleren we dat de verdelingen verschillend zijn.
%		\begin{itemize}
%			\item $H_{0}$: steekproef is representatief naar populatie
%			\item $H_{1}$: steekproef is niet representatief naar populatie
%		\end{itemize}
%	\item \textbf{Bepalen $\alpha$ en $n$} : $\alpha = 0,05$ en $n = 400$.
%	\item \textbf{Toetsingsgrootheid en waarde ervan in steekproef}:
%	\[ \chi^{2} = \sum_{i=1}^{n} \frac{(o_{i} - e_{i})^{2}}{e_{i}} \]
%	\item \textbf{Bereken en teken kritiek gebied}: de toets is altijd rechtszijdig. Is de toetsingsgrootheid kleiner dan kritieke grenswaarde verwerp $H_{0}$ niet, anders verwerp $H_{0}$ en aanvaard $H_{1}$. 
%\end{enumerate}
%
%\subsection{Voorbeeld 2}
%
%Beschouw alle gezinnen met 5 kinderen in een bepaalde gemeenschap. Met betrekking tot samenstelling zijn er 6 mogelijkheden. 
%\begin{enumerate}
%	\item 5 jongens
%	\item 4 jongens, 1 meisje
%	\item 3 jongens, 2 meisjes
%	\item 2 jongens, 3 meisjes
%	\item 1 jongen, 4 meisjes
%	\item 5 meisjes
%\end{enumerate}
%
%Het onderzoek bevat 1022 gezinnen met 5 kinderen en resultaten staan beschreven in de slides (kolom = aantal jongens). Zijn de waargenomen aantallen in de 6 klassen representatief voor een populatie waar de kans om een jongen te krijgen = kans om een meisje te krijgen = 0,5?
%
%Indien de veronderstelling waar is wordt de kans $\pi_{i}$ om $i$ jongens te krijgen bepaald door een binominaalvedeling met parameters $n=5$ en $p=0,5$.
%
%Dit kan je eenvoudig nagaan aan de hand van voorbeeld. De kans om 2 jongens te krijgen met 5 kinderen is gelijk aan :
%
%\[ (0,5)^{2} \times (1-0,5)^{5-2} \times \binom{5}{2} \]
% 
%Algemeen geldt dus:
%
%\[ \pi_{i} = \binom{5}{i}\times 0,5^{i} \times 0,5^{5-i} = \frac{5!}{i!(5-i)!}\times 0,5^{i} \]
%
%Met deze $\pi_{i}$ kunnen we dus de verwachte waarde bepalen en de stappen volgen zoals hierboven beschreven. 
%
%\begin{enumerate}
%	\item \textbf{Bepalen hypotheses}
%		
%		\begin{itemize}
%			\item $H_{0}$: steekproef is representatief naar populatie
%			\item $H_{1}$: steekproef is niet representatief naar populatie
%		\end{itemize}
%	\item \textbf{Bepalen $\alpha$ en $n$} : $\alpha = 0,01$ en $n = 1022$.
%	\item \textbf{Toetsingsgrootheid en waarde ervan in steekproef}:
%	\[ \chi^{2} = \sum_{i=1}^{n} \frac{(o_{i} - e_{i})^{2}}{e_{i}} = 29,5766 \]
%	\item \textbf{Bereken en teken kritiek gebied}:  kritieke grens is 15,0863. Onze toetsingsgrootheid ligt dus in het kritieke gebied dus verwerpen we $H_{0}$. 
%\end{enumerate}
%
%We vinden dus dat de steekproef niet representatief is naar een populatie waar geldt dat de kans op een jongen even groot is als de kans op een meisje. Het is interessant om te kijken naar de gestandaardiseerde residuen die aanduiden welke klassen de grootste bijdrage leveren aan de waarde van de grootheid. 
%
%\[ r_{i} = \frac{O_{i} - n \pi_{i}}{\sqrt{n \pi_{i}(1-\pi_{i})}} \]
%
%\begin{exercise}
%	Hoe komen we hier aan de noemer? Waar komt dit mee overeen? Hoe bepaal je de variantie van een binomiale verdeling?
%Antwoord: $n \times \pi (1-\pi)$
%\end{exercise}
%
%
%
%Er geldt algemeen dat waarden groter dan 2 of kleiner dan $-2$ extreem zijn. We kunnen dus besluiten dat het aantal gezinnen waarin alle kinderen hetzelfde geslacht hebben groter mag worden genoemd dan verwacht.
%
%\subsection{Voorwaarden}
% Om de toets te mogen toepassen dient aan de volgende voorwaarden te zijn voldaan (Regel van Cochran)
%\begin{enumerate}
%	\item Voor alle categorie\"en moet gelden dat de verwachte waarde $e$ groter is dan 1.
%	\item In ten hoogste 20 \% van de categori\"en mag de verwachte waarde $e$ kleiner dan 5 zijn.
%\end{enumerate}
%
%
%\section{\texorpdfstring{$\chi^{2}$}{Chi-kwadraat}-kruistabeltoets}
%De Chi-kwadraattoets \index{$\chi^{2}$kwadraatkruistabeltoets} laat zich eenvoudig uitbreiden tot een onderzoeksontwerp
%met twee variabelen, met respectievelijk $r$ en $k$ niveaus. Hier gaan we onderzoeken of er een verband is tussen 2 variabelen. De procedure kan opnieuw geformuleerd worden.
%
%We gaan de procedure na aan de hand van een studie door \textcite{Doll1954} over de relatie tussen roken en longkanker. Doll en Hill schreven in 1951 alle Britse huisartsen aan met het verzoek om gegevens over hun leeftijd en rookgedrag. Vervolgens hielden ze jarenlang de overlijdensberichten en de doodsoorzaak bij en herhaalden hun periodiek. De eerste uitkomsten, na circa vier jaar, zijn in tabel~\ref{tab:dollhill} samengevat. Uit de tabel kan makkelijk geconcludeerd worden dat er geen relatie is tussen roken en longkanker. In (ruim) vier jaar is slechts $(84 / 24354) * 100 = 0,35\% $ van de Britse artsen aan longkanker overleden en dat met slechts $(83 / 21261) * 100 = 0,39\%$ van de rokers onder hen. Dit is weinig, maar het is wel veel meer dan hetzelfde cijfer voor de niet-rokers $(1 / 3093) * 100 = 0,032\%$.
%
%
%\begin{table}
%  \begin{center}
%    \begin{tabular}{@{}lllll@{}}
%      \toprule
%                       & \textbf{Longkanker} & \textbf{Niet} & \textbf{Wel} & \textbf{Totaal} \\
%        \midrule
%        \textbf{Roker} & \textbf{Wel}        & 21178         & 83           & 21261           \\
%                       & \textbf{Niet}       & 3092          & 1            & 3093            \\
%                       & \textbf{Totaal}     & 24270         & 84           & 24354           \\
%        \bottomrule
%    \end{tabular}
%  \end{center}
%  \caption{Resultaten van het onderzoek van~\textcite{Doll1954}}
%  \label{tab:dollhill}
%\end{table}
%
%We zien in de tabel dat er wel een erg groot verschil is tussen de geobserveerde aantallen rokers die overlijden aan longkanker en de verwachte waarden in deze cel. Hetzelfde geldt voor het geringe aantal huisartsen dat niet rookt, maar wel aan longkanker overleden is. Deze observatie maakt ons wel wantrouwig of de eerdere tentatieve conclusie wel juist is. We kunnen om aan deze onzekerheid de toetsingsgrootheid $\chi^{2}$ uitrekenen. Dat doen we op de vertrouwde manier:
%
%
%\begin{enumerate}
%	\item \textbf{Bepalen hypotheses}	
%		\begin{itemize}
%			\item $H_{0}$: in de populatie is er geen samenhang tussen onafhankelijke en afhankelijke variabele
%			\item $H_{1}$: er bestaat wel een samenhang tussen de variabelen in de populatie
%		\end{itemize}
%	\item \textbf{Bepalen $\alpha$ en $n$} : $\alpha = 0,05$ en $n = 24354$.
%	\item \textbf{Toetsingsgrootheid en waarde ervan in steekproef}:
%	\[ \chi^{2} = \sum_{i=1}^{n} \frac{(o_{i} - e_{i})^{2}}{E_{i}} = 10,35 \]
%	\item \textbf{Bereken en teken kritiek gebied}:  kritieke grens is 3,8415 en aantal vrijheidsgraden $df = (r-1)(k-1)$ Onze toetsingsgrootheid ligt dus in het kritieke gebied dus verwerpen we $H_{0}$. 
%\end{enumerate}
%
%We moeten derhalve $H_{0}$, dat er geen relatie is tussen beide variabelen, verwerpen ten gunste van $H_{1}$ dat er wel een relatie is tussen beide variabelen: rokers sterven vaker aan longkanker dan niet-rokers.
%
%Maar, is dit nu een bewijs dat zoals zo vaak verondersteld wordt dat roken longkanker veroorzaakt? Nee, dat is het absoluut niet. Een paar alternatieve verklaringen: niet alle rokers krijgen longkanker, de rokers zijn ouder dan de niet-rokers, de rokers wonen veelal in de grote steden met
%meer vervuilde lucht dan de niet-rokers die veelal op het platte land wonen, ook zo erg nog een speciale genetische dispositie kunnen zijn, die zowel van invloed is op de verslaving aan tabak, als op de kans om longkanker te krijgen. Voor een causale interpretatie van de gegevens (let wel, het betreft hier immers geen experiment), moeten we op zijn minst de beschikking hebben over een theorie die de relatie tussen roken en longkanker expliciteert.
%
%\subsection{Voorwaarden}
%Aan het voorwaarden van de $\chi^{2}$-kruistabeltoest zijn voorwaarden verbonden (regel van Cochran).
%\begin{enumerate}
%	\item Voor alle cellen moet gelden dat de verwachte waarde $e$ groter is dan 1.
%	\item in ten hoogste 20\% van de cellen mag de verwachte waarde $e$ kleiner zijn dan 5.
%\end{enumerate}
%


\section{Exercises}
\label{sec:chi-squared-exercises}

\begin{exercise}
  \label{ex:chisq-survey}
  This exercise makes use of the dataset \texttt{survey} that is included in R. The set contains results of a survey among students. In order to load the dataset, issue the following commands:
  
  \begin{lstlisting}
  library(MASS)
  View(survey)  # Show the "survey" dataset
  ?survey       # Help-page for the dataset, explains the contents
  \end{lstlisting}
  
  If you get an error message when loading the library (first line), this means that the package \texttt{MASS} is not yet instsalled. You can do this with Tools > Install Packages; fill out the package name in the text field.
  
  We want to know whether there is a relation between some discrete (i.e.~nominal or ordinal) variables in this dataset. For each of the pairs of variables, perform the following steps:
  
\begin{enumerate}[label=(\alph*)]
    \item First, reflect on the outcome you expect for the given set of variables.
    \item Determine a contingency table for the two variables. The (suspected) independent variable comes first.
    \item Plot a graph of the data, e.g.~a clustered bar chart, stacked percentage bar chart, or a ``mosaic chart'' (simply with \texttt{plot(table(data\$col1, data\$col2))}).
    \item If you look at the chart, do you expect a high or low value of the $\chi^2$-statistic? Why?
    \item Calculate the $\chi^2$-statistic and the critical value $g$ (for significance level $\alpha = 0.05$)
    \item Calculate the $p$-value
    \item Do we need to accept the null hypothesis, or can we reject it? What does that exactly mean for the relation between the two variables?
  \end{enumerate}
  
  The variables to be researched are given below. The suspected independent variable is the first.
  
  \begin{enumerate}
    \item \texttt{Exer} (sport habit) and \texttt{Smoke} (smoking habit)
    \item \texttt{W.Hnd} (writing hand) and \texttt{Fold} (the hand on top when folding arms)
    \item \texttt{Sex} and \texttt{Smoke}
    \item \texttt{Sex} and \texttt{W.Hnd}
  \end{enumerate}
\end{exercise}

\begin{exercise}
  \label{ex:chisq-aids2}
  Load the dataset \texttt{Aids2} from the package \texttt{MASS} (see Exercise~\ref{ex:chisq-survey}) that contains data about 2843 patients diagnosed with AIDS in Australia before 1991. This dataset was discussed in detail by ~\textcite{Ripley2007}. Determine whether there is a relation between the variables (\texttt{Sex}) and the way the disease was transmitted (\texttt{T.categ}).
  
  \begin{enumerate}
    \item Follow the usual steps: calculate contingency table, visualise the data, calculate the $\chi^2$, $g$ and $p$-value ($\alpha = 0,05$), and formulate a conclusion.
    \item Determine the standardised residuals in order to determine which categories contain extreme values.
  \end{enumerate}
  
\end{exercise}

\begin{exercise}
  \label{ex:chisq-digimeter}
  
  Every year, Imec (formerly iMinds) performs a study on the use of digital technologies in Flanders, the Digimeter~\autocite{Vanhaelewyn2016}. In this exercise, we're going to check whether the sample of the Digimeter 2016 ($n = 2164$) is representative for the Flemish population with regards to the age categories of the participants.
  
  Table~\ref{tab:digimeter2016} gives the relative frequencies of the participants. The absolute frequencies for the different age categories of the Flemish population is summarised in Table~\ref{tab:leeftijd-vlaanderen}, and is also included in CSV-file \texttt{exercises/data/bestat-vl-ages.csv}.
  
  \begin{enumerate}
    \item The table with age categories of the Flemish population has more categories than those used in the Digimeter. Recalculate the frequencies so you get the same categories as used in the Digimeter. Tip: this will probably be easier in a spreadsheet than in R.
    \item In order to apply a goodness-of-fit test, you need the absolute frequencies of the observed values in the sample. Calculate those.
    \item Also calculate the expected percentages ($\pi_{i}$) from the population frequencies.
    \item Perform a goodness-of-fit test over the distribution of age categories in the sample of the Digimeter 2016. Is the sample representative for the Flemish population?
  \end{enumerate}
\end{exercise}

\begin{table}
  \caption{Relative frequencies of age categories of the participants in the iMec Digimeter 2016 and the Flemish population.}
  \label{tab:frequenties-leeftijden}
  \centering
  \begin{tabular}{cc}
    \textbf{Age group} & \textbf{Percentage} \\ \midrule
    15-19 & 6,6\% \\
    20-29 & 14,2\% \\
    30-39 & 15,0\% \\
    40-49 & 16,3\% \\
    50-59 & 17,3\% \\
    60-64 & 7,3\% \\
    64+   & 23,2\% \\
  \end{tabular}
  \subcaption{Percentage of participants in the iMec Digimeter 2016 ($n = 2164$), per age category. \autocite{Vanhaelewyn2016}}
  \label{tab:digimeter2016}
  
  \centering
  \begin{tabular}{cc}
    \textbf{Age group} & \textbf{Frequency} \\ \midrule
    â€“5            &     352017      \\
    5-9           &     330320      \\
    10-14          &     341303      \\
    15-19          &     366648      \\
    20-24          &     375469      \\
    25-29          &     387131      \\
    30-34          &     401285      \\
    35-39          &     409587      \\
    40-44          &     458485      \\
    45-49          &     493720      \\
    50-54          &     463668      \\
    55-59          &     413315      \\
    60-64          &     379301      \\
    65-69          &     299152      \\
    70-74          &     279789      \\
    75-79          &     249260      \\
    80-84          &     182352      \\
    85-89          &     104449      \\
    90-94          &      29888      \\
    95-99          &      7678       \\
    100+           &       923
  \end{tabular}
  \subcaption{Absolute frequencies of the Flemish population per age category. Source: BelStat (\url{https://bestat.economie.fgov.be/bestat/}, C01.1: Bevolking volgens verblijfplaats (provincie), geslacht, positie in het huishouden (C), burgerlijke staat en leeftijd (B)).}
  \label{tab:leeftijd-vlaanderen}
  
  
\end{table}

\section{Solutions to selected exercises}
\label{sec:chi-squared-solutions}

\paragraph{Exercise~\ref{ex:chisq-survey}}

\begin{enumerate}
  \item \texttt{Exer}/\texttt{Smoke}: $\chi^2 = 5.49$, $g = 12.5916$, $p \approx 0.483$
  \item \texttt{W.Hnd}/\texttt{Fold}: $\chi^2 = 1.581399$, $g = 5.9915$, $p \approx 0.454$
  \item \texttt{Sex}/\texttt{Smoke}: $\chi^2 = 3.554$, $g = 7.8147$, $p \approx 0.314$
  \item \texttt{Sex}/\texttt{W.Hnd}: $\chi^2 = 0.236$, $g = 3.8415$, $p \approx 0.627$
\end{enumerate}

\paragraph{Exercise~\ref{ex:chisq-aids2}} $\chi^2 = 1083.372914$, $g = 14.067140$, $p \approx 1.157 \times 10^{-229}$

\paragraph{Exercise~\ref{ex:chisq-digimeter}} $\chi^2 = 6.6997$, $g = 12.5916$, $p \approx 0.35$